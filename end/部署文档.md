# Oimo Blog 项目部署文档

## 项目简介

这是一个简单的博客日志系统，包含：
- 前端：Vue3 + Element Plus
- 后端：Django + Django REST Framework
- 数据库：MySQL

## 一、服务器环境准备

### 1.1 系统要求
- Linux 操作系统（Ubuntu 20.04+ 或 CentOS 7+）
- Python 3.13.5 或以上版本
- MySQL 5.7+ 或 MySQL 8.0+
- Node.js 18+ 和 npm
- Nginx（用于反向代理）

### 1.2 安装基础软件

```bash
# Ubuntu/Debian 系统
sudo apt update
sudo apt install -y python3.13 python3.13-venv python3-pip
sudo apt install -y nodejs npm
sudo apt install -y nginx

# CentOS/RHEL 系统
sudo yum install -y python3 python3-pip
sudo yum install -y nodejs npm
sudo yum install -y nginx
```

## 二、数据库配置

### 2.1 登录 MySQL

```bash
mysql -u root -p
```

### 2.2 创建数据库和用户

```sql
-- 创建数据库
CREATE DATABASE oimo_blog CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 创建用户（请修改密码）
CREATE USER 'oimo_user'@'localhost' IDENTIFIED BY 'your_strong_password';

-- 授权
GRANT ALL PRIVILEGES ON oimo_blog.* TO 'oimo_user'@'localhost';
FLUSH PRIVILEGES;

-- 退出
EXIT;
```

## 三、后端部署

### 3.1 上传代码到服务器

```bash
# 在服务器上创建项目目录
mkdir -p /var/www/oimo-blog
cd /var/www/oimo-blog

# 使用 scp 或 git 上传代码
# 示例：从本地上传
scp -r D:\vuego\end user@your_server_ip:/var/www/oimo-blog/
```

### 3.2 配置后端环境

```bash
cd /var/www/oimo-blog/end

# 创建虚拟环境
python3 -m venv venv

# 激活虚拟环境
source venv/bin/activate

# 安装依赖
pip install -r requirements.txt

# 安装 gunicorn（生产环境服务器）
pip install gunicorn
```

### 3.3 配置环境变量

```bash
# 复制环境变量模板
cp .env.example .env

# 编辑 .env 文件
nano .env
```

修改以下内容：
```
DB_NAME=oimo_blog
DB_USER=oimo_user
DB_PASSWORD=your_strong_password
DB_HOST=localhost
DB_PORT=3306

SECRET_KEY=your-django-secret-key-change-this
DEBUG=False
```

### 3.4 初始化数据库

```bash
# 生成数据库迁移文件
python manage.py makemigrations

# 执行迁移
python manage.py migrate

# 创建超级用户（用于访问 Django admin）
python manage.py createsuperuser

# 收集静态文件
python manage.py collectstatic --noinput
```

### 3.5 测试后端运行

```bash
# 测试运行
python manage.py runserver 0.0.0.0:8000

# 如果能正常访问，按 Ctrl+C 停止
```

### 3.6 配置 Gunicorn 服务

创建 systemd 服务文件：

```bash
sudo nano /etc/systemd/system/oimo-blog.service
```

添加以下内容：
```ini
[Unit]
Description=Oimo Blog Django Application
After=network.target

[Service]
Type=notify
User=www-data
Group=www-data
WorkingDirectory=/var/www/oimo-blog/end
Environment="PATH=/var/www/oimo-blog/end/venv/bin"
ExecStart=/var/www/oimo-blog/end/venv/bin/gunicorn \
    --workers 3 \
    --bind 127.0.0.1:8000 \
    --timeout 60 \
    --access-logfile /var/log/oimo-blog/access.log \
    --error-logfile /var/log/oimo-blog/error.log \
    blog.wsgi:application

[Install]
WantedBy=multi-user.target
```

创建日志目录并启动服务：

```bash
# 创建日志目录
sudo mkdir -p /var/log/oimo-blog
sudo chown www-data:www-data /var/log/oimo-blog

# 修改项目权限
sudo chown -R www-data:www-data /var/www/oimo-blog

# 重新加载 systemd
sudo systemctl daemon-reload

# 启动服务
sudo systemctl start oimo-blog

# 设置开机自启
sudo systemctl enable oimo-blog

# 查看状态
sudo systemctl status oimo-blog
```

## 四、前端部署

### 4.1 上传前端代码

```bash
# 上传前端代码到服务器
scp -r D:\vuego\front user@your_server_ip:/var/www/oimo-blog/
```

### 4.2 构建前端项目

```bash
cd /var/www/oimo-blog/front

# 安装依赖
npm install

# 构建生产版本
npm run build

# 构建完成后，dist 目录包含静态文件
```

## 五、配置 Nginx

### 5.1 创建 Nginx 配置文件

```bash
sudo nano /etc/nginx/sites-available/oimo-blog
```

添加以下内容：
```nginx
server {
    listen 80;
    server_name your_domain.com;  # 修改为你的域名或服务器IP

    # 前端静态文件
    location / {
        root /var/www/oimo-blog/front/dist;
        try_files $uri $uri/ /index.html;
    }

    # 后端 API
    location /api/ {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Django admin
    location /admin/ {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Django 静态文件
    location /static/ {
        alias /var/www/oimo-blog/end/staticfiles/;
    }
}
```

### 5.2 启用配置并重启 Nginx

```bash
# 创建软链接
sudo ln -s /etc/nginx/sites-available/oimo-blog /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t

# 重启 Nginx
sudo systemctl restart nginx

# 设置开机自启
sudo systemctl enable nginx
```

## 六、防火墙配置

### 6.1 开放必要端口

```bash
# Ubuntu/Debian (使用 ufw)
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw enable

# CentOS/RHEL (使用 firewalld)
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https
sudo firewall-cmd --reload
```

## 七、SSL 证书配置（可选但推荐）

### 7.1 使用 Let's Encrypt 免费证书

```bash
# 安装 certbot
sudo apt install certbot python3-certbot-nginx  # Ubuntu/Debian
# 或
sudo yum install certbot python3-certbot-nginx  # CentOS/RHEL

# 获取证书并自动配置 Nginx
sudo certbot --nginx -d your_domain.com

# 测试自动续期
sudo certbot renew --dry-run
```

## 八、验证部署

### 8.1 检查服务状态

```bash
# 检查后端服务
sudo systemctl status oimo-blog

# 检查 Nginx
sudo systemctl status nginx

# 查看后端日志
sudo tail -f /var/log/oimo-blog/error.log
```

### 8.2 访问应用

- 前端页面：`http://your_server_ip` 或 `http://your_domain.com`
- 后端 API：`http://your_server_ip/api/blogs/`
- Django 管理后台：`http://your_server_ip/admin/`

## 九、日常维护

### 9.1 更新代码

```bash
# 后端更新
cd /var/www/oimo-blog/end
source venv/bin/activate
git pull  # 或重新上传文件
python manage.py migrate
sudo systemctl restart oimo-blog

# 前端更新
cd /var/www/oimo-blog/front
git pull  # 或重新上传文件
npm run build
```

### 9.2 查看日志

```bash
# 后端日志
sudo tail -f /var/log/oimo-blog/access.log
sudo tail -f /var/log/oimo-blog/error.log

# Nginx 日志
sudo tail -f /var/log/nginx/access.log
sudo tail -f /var/log/nginx/error.log

# 系统日志
sudo journalctl -u oimo-blog -f
```

### 9.3 数据库备份

```bash
# 创建备份脚本
sudo nano /usr/local/bin/backup-oimo-blog.sh
```

添加以下内容：
```bash
#!/bin/bash
BACKUP_DIR="/var/backups/oimo-blog"
DATE=$(date +%Y%m%d_%H%M%S)
mkdir -p $BACKUP_DIR

mysqldump -u oimo_user -p'your_strong_password' oimo_blog > $BACKUP_DIR/oimo_blog_$DATE.sql

# 保留最近7天的备份
find $BACKUP_DIR -name "*.sql" -mtime +7 -delete
```

```bash
# 设置执行权限
sudo chmod +x /usr/local/bin/backup-oimo-blog.sh

# 添加定时任务（每天凌晨2点备份）
sudo crontab -e
# 添加：0 2 * * * /usr/local/bin/backup-oimo-blog.sh
```

## 十、故障排查

### 10.1 常见问题

1. **502 Bad Gateway**
   - 检查 gunicorn 服务是否运行：`sudo systemctl status oimo-blog`
   - 查看错误日志：`sudo tail -f /var/log/oimo-blog/error.log`

2. **数据库连接失败**
   - 检查 .env 文件配置
   - 确认 MySQL 服务运行：`sudo systemctl status mysql`
   - 检查数据库用户权限

3. **静态文件 404**
   - 确认已执行：`python manage.py collectstatic`
   - 检查 Nginx 配置中的静态文件路径

4. **CORS 错误**
   - 检查 Django settings.py 中的 CORS 配置
   - 确认前端 API 请求地址正确

## 十一、性能优化建议

1. **启用 Gzip 压缩**（在 Nginx 配置中添加）
2. **配置缓存**（对静态资源设置缓存头）
3. **使用 Redis**（缓存数据库查询结果）
4. **CDN 加速**（对静态资源使用 CDN）
5. **数据库优化**（添加索引，优化查询）

## 附录：快速部署脚本

创建一键部署脚本 `deploy.sh`：

```bash
#!/bin/bash
set -e

echo "开始部署 Oimo Blog..."

# 后端部署
cd /var/www/oimo-blog/end
source venv/bin/activate
pip install -r requirements.txt
python manage.py migrate
python manage.py collectstatic --noinput
sudo systemctl restart oimo-blog

# 前端部署
cd /var/www/oimo-blog/front
npm install
npm run build

# 重启服务
sudo systemctl restart nginx

echo "部署完成！"
```

使用方法：
```bash
chmod +x deploy.sh
./deploy.sh
```

---

**注意事项：**
1. 请务必修改所有默认密码
2. 生产环境请设置 `DEBUG=False`
3. 定期备份数据库
4. 保持系统和依赖包更新
5. 配置防火墙和安全组规则
6. 使用 HTTPS 加密传输
