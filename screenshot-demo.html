<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æµè§ˆå™¨æˆªå›¾åŠŸèƒ½æ¼”ç¤º</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
    }
    button {
      padding: 12px 24px;
      font-size: 16px;
      background: #409eff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.3s;
    }
    button:hover {
      background: #66b1ff;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .status {
      margin-top: 20px;
      padding: 10px;
      border-radius: 4px;
      display: none;
    }
    .status.show {
      display: block;
    }
    .status.success {
      background: #f0f9ff;
      color: #409eff;
      border: 1px solid #b3d8ff;
    }
    .status.error {
      background: #fef0f0;
      color: #f56c6c;
      border: 1px solid #fbc4c4;
    }
    .preview {
      margin-top: 20px;
      border: 1px solid #ddd;
      border-radius: 4px;
      overflow: hidden;
      display: none;
    }
    .preview.show {
      display: block;
    }
    .preview img {
      max-width: 100%;
      display: block;
    }
    .info {
      background: #f5f7fa;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 20px;
      font-size: 14px;
      line-height: 1.6;
    }
    .info code {
      background: #e4e7ed;
      padding: 2px 6px;
      border-radius: 2px;
      font-family: Consolas, Monaco, monospace;
    }
  </style>
</head>
<body>
  <h1>ğŸ–¼ï¸ æµè§ˆå™¨æˆªå›¾åŠŸèƒ½æ¼”ç¤º</h1>

  <div class="info">
    <strong>åŠŸèƒ½è¯´æ˜ï¼š</strong><br>
    1. ç‚¹å‡»æŒ‰é’®åï¼Œæµè§ˆå™¨ä¼šå¼¹å‡º"é€‰æ‹©è¦å…±äº«çš„å†…å®¹"çª—å£<br>
    2. å¯é€‰æ‹©æ•´ä¸ªå±å¹•ã€ç‰¹å®šçª—å£æˆ–æµè§ˆå™¨æ ‡ç­¾é¡µ<br>
    3. é€‰æ‹©åä¼šç«‹å³æˆªå›¾å¹¶è‡ªåŠ¨ä¸‹è½½<br>
    4. ä½¿ç”¨ <code>navigator.mediaDevices.getDisplayMedia()</code> API
  </div>

  <button id="screenshotBtn">ğŸ“¸ å¼€å§‹æˆªå›¾</button>

  <div id="status" class="status"></div>
  <div id="preview" class="preview"></div>

  <script>
    const btn = document.getElementById('screenshotBtn')
    const statusEl = document.getElementById('status')
    const previewEl = document.getElementById('preview')

    // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
    function showStatus(message, type = 'success') {
      statusEl.textContent = message
      statusEl.className = `status show ${type}`
      setTimeout(() => {
        statusEl.classList.remove('show')
      }, 3000)
    }

    // æ˜¾ç¤ºé¢„è§ˆ
    function showPreview(imgUrl) {
      previewEl.innerHTML = `
        <img src="${imgUrl}" alt="æˆªå›¾é¢„è§ˆ">
        <div style="padding: 10px; background: #f5f7fa;">
          <small>æˆªå›¾é¢„è§ˆï¼ˆå·²è‡ªåŠ¨ä¸‹è½½åˆ°æœ¬åœ°ï¼‰</small>
        </div>
      `
      previewEl.classList.add('show')
    }

    // æˆªå›¾åŠŸèƒ½
    async function takeScreenshot() {
      // æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
      if (!navigator.mediaDevices || !navigator.mediaDevices.getDisplayMedia) {
        showStatus('âŒ å½“å‰æµè§ˆå™¨ä¸æ”¯æŒå±å¹•æˆªå›¾åŠŸèƒ½', 'error')
        return
      }

      try {
        // ç¦ç”¨æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
        btn.disabled = true
        btn.textContent = 'ğŸ“¸ è¯·é€‰æ‹©è¦æˆªå›¾çš„å†…å®¹...'

        // 1. è·å–å±å¹•å…±äº«æµ
        const stream = await navigator.mediaDevices.getDisplayMedia({
          video: {
            mediaSource: 'screen' // ä¼˜å…ˆé€‰æ‹©å±å¹•ï¼ˆå¯é€‰ 'window', 'screen', 'browser'ï¼‰
          }
        })

        btn.textContent = 'ğŸ“¸ æ­£åœ¨å¤„ç†æˆªå›¾...'

        // 2. åˆ›å»ºè§†é¢‘å…ƒç´ 
        const video = document.createElement('video')
        video.srcObject = stream
        video.play()

        // 3. ç­‰å¾…è§†é¢‘å…ƒæ•°æ®åŠ è½½å®Œæˆ
        await new Promise((resolve) => {
          video.onloadedmetadata = resolve
        })

        // 4. åˆ›å»º Canvas å¹¶ç»˜åˆ¶è§†é¢‘å¸§
        const canvas = document.createElement('canvas')
        canvas.width = video.videoWidth
        canvas.height = video.videoHeight
        const ctx = canvas.getContext('2d')
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height)

        // 5. åœæ­¢æ‰€æœ‰åª’ä½“è½¨é“ï¼ˆå…³é—­å±å¹•å…±äº«ï¼‰
        stream.getTracks().forEach(track => track.stop())

        // 6. è½¬æ¢ä¸ºå›¾ç‰‡ URL
        const imgUrl = canvas.toDataURL('image/png')

        // 7. è§¦å‘ä¸‹è½½
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5)
        const filename = `screenshot-${timestamp}.png`

        const a = document.createElement('a')
        a.href = imgUrl
        a.download = filename
        a.click()

        // 8. æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯å’Œé¢„è§ˆ
        showStatus(`âœ… æˆªå›¾æˆåŠŸï¼å·²ä¿å­˜ä¸º ${filename}`, 'success')
        showPreview(imgUrl)

      } catch (error) {
        // å¤„ç†é”™è¯¯
        if (error.name === 'NotAllowedError') {
          showStatus('âŒ ç”¨æˆ·å–æ¶ˆäº†å±å¹•å…±äº«', 'error')
        } else if (error.name === 'NotFoundError') {
          showStatus('âŒ æœªæ‰¾åˆ°å¯ç”¨çš„å±å¹•å…±äº«æº', 'error')
        } else {
          showStatus(`âŒ æˆªå›¾å¤±è´¥: ${error.message}`, 'error')
        }
        console.error('æˆªå›¾é”™è¯¯:', error)
      } finally {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        btn.disabled = false
        btn.textContent = 'ğŸ“¸ å¼€å§‹æˆªå›¾'
      }
    }

    // ç»‘å®šç‚¹å‡»äº‹ä»¶
    btn.addEventListener('click', takeScreenshot)

    // æ˜¾ç¤ºæµè§ˆå™¨ä¿¡æ¯ï¼ˆé¢å¤–æ¼”ç¤º navigator çš„å…¶ä»–ç”¨æ³•ï¼‰
    console.log('=== Navigator å¯¹è±¡ä¿¡æ¯ ===')
    console.log('ç”¨æˆ·ä»£ç†:', navigator.userAgent)
    console.log('å¹³å°:', navigator.platform)
    console.log('è¯­è¨€:', navigator.language)
    console.log('åœ¨çº¿çŠ¶æ€:', navigator.onLine)
    console.log('Cookie å¯ç”¨:', navigator.cookieEnabled)
    console.log('ç¡¬ä»¶å¹¶å‘æ•°:', navigator.hardwareConcurrency)
  </script>
</body>
</html>
